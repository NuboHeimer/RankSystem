Ранговая система для [streamer.bot](https://streamer.bot/). Работает как для нативных площадок, представленных в боте (twitch, youtube, trovo), так и для площадок поддерживаемых [миничатом](https://t.me/streamix_group/3). Для подключения миничата к стримерботу воспользуйтесь [интеграцией](https://docs.play-code.ru/minichat). Последнюю, на данный момент, версию интеграции можно найти в [streamfony](https://t.me/StreamfonyBot?start=_tgr_JpK_P4xlZmI6), раздел "плагины".

Вопросы пишите в соответствующий топик: https://t.me/nuboheimersb/5.

Видеогайд будет сделан в будущем.

⚠ Получение списка зрителей на вк видео лайв стало невозожным с 18.02.2025.
⚠ Говорят, что адекватный список доступен через api. Рано или поздно, я попробую им воспользоваться.

## Реализованный функционал.
На данный момент система умеет:
- начислять внутреннюю валюту (далее -- коины) по любому триггеру бота, в котором приходит *userName*, *userId* (*minichat.Data.UserID* для миничата), *eventSource*/*commandSource*. На всех площадках.
- запоминать дату фоллова на канал. На всех площадках, для которых есть соответствующий триггер.
- запомниать категорию стрима которая была при фоллове. Только twitch.
- запоминать количество сообщений пользователя. На всех площадках, для которых есть соответствующий триггер.
- запоминать количество времени, которое пользователь смотрел стрим.
    - Twitch.
    - Trovo под вопросом, нужны живые тесты.
    - Youtube не предоставляет список зрителей. Поэтому время запоминается только в том случае, если пользователь писал в чат в определённый период времени. Настройки описаны ниже.
    - VkVideoLive ~~работает при наличии [моей интеграции](https://github.com/NuboHeimer/VkVideoLiveService/releases) для этой площадки.~~ не работает с 18.02.2025
- выводить количество коинов пользователя. На всех площадках.
- выводить игру, на которой зафлловился пользователь. Только twitch.
- выводить время просмотра стрима пользователем. Только twitch, ~~vkvideolive~~, trovo, youtube.
- выводить топ пользователей по времени просмотра, количеству сообщений, накопленным коинам.
- игнорировать пользователей из чёрного списка.
- очищать количество коинов у всех пользователей.
- обнулять базу полностью.

## Запланированный функционал.
https://github.com/users/NuboHeimer/projects/3/views/1

## Содержаение файла импорта и настройка.
### Очереди
- **RankSystem** -- блокирующая очередь для корректной работы ранговой системы. Все экшены, взаимодействующие с ранговой системой необходимо создавать в этой очереди.
### Таймеры
- **VKVideoLive** -- нужен для получения времени просмотра на VKVideoLive. **Не работает с 18.02.2025**
### Команды
- **\[Топ] Время** -- пример команды для вывода топа пользователей по времени просмотра.
- **\[Топ] Монеты** -- пример команды для вывода топа пользователей по накопленным коинам.
- **\[Топ] Сообщений** -- пример команды для вывода топа пользователей по сообщениям.
- **follow** -- пример команды для вывода информации о фолловере. На данный момент выводит игру, на которой зафолловился пользователь.
- **followDate** -- пример команды для вывода информации о дате фоллова.
- **watchtime** -- пример команды для вывода информации о времени просмотра стримов пользователем.
- **всё** -- пример команды для вывода всей информации по пользователю вида "%userName% зафолловился %followDate%. Его привлекла %gameWhenFollow%. Он насмотрел уже %watchTime%, накопил %coins% и нафлудил %messageCount%."
- **Коины** -- пример команды для вывода информации о количестве коинов у пользователя.
- **флуд** -- пример команды для вывода информации о количестве сообщений пользователя.
### Экшены группы \[RankSystem]
- **\[RankSystem] Add Coins** -- экшен добавлят пользователю указанное количество коинов. Для корректной работы необходимо наличие аргументов *coinsToAdd*, *userName*, *userId* или *minichat.Data.UserID*, *eventSource* или *commandSource*.
    При вызове через триггер все аргументы кроме *coinsToAdd* берутся из данных триггера.
    В целевом экшене:
    - задайте **Core -> Arguments -> Set Argument**. В **Variable Name** укажите *coinsToAdd*. В **Value** *количесто коинов*.
    - сделайте вызов **Core -> Actions -> Run Action** и выберите описываемый экшен (**\[RankSystem] Add Coins**).
- **\[RankSystem] Code** -- экшен с основным кодом.
- **\[RankSystem] Get All User Data** -- экшен получает всю информацию по пользователю по команде **!всё**, записывает её в соответствующие аргументы и отправляет в чат.
- **\[RankSystem] Get Coins Count** -- экшен записывает количество коинов пользователя в аргумент *%coins%* по команде **!coins**. На данный момент записываются коины только для вызвашего команду. Для отправки в чат необходимо задать аргумент *%reply%* вида *%userName%* накопил *%coins%*. После чего вызвать метод **SendReply**. Экшен поставляется с настроеным примером.
- **\[RankSystem] Get Follow Date** -- экшен записывает дату фоллова пользователя вызвавшего команду **!followDate** в аргумент *%followDate%*. На данный момент записывается дата только для вызвашего команду. Для отправки в чат необходимо задать аргумент *%reply%* вида *%userName%* зафолловился *%followDate%*. После чего вызвать метод **SendReply**. Экшен поставляется с настроеным примером.
- **\[RankSystem] Get Game When Follow** -- экшен записывает категорию стрима, на которой фолловился пользователь вызвавший команду **!follow** в аргумент *%gameWhenFollow%*. На данный момент записывается категория только для вызвашего команду. Для отправки в чат необходимо задать аргумент *%reply%* вида *%userName%* зафолловился на *%gameWhenFollow%*. После чего вызвать метод **SendReply**. Экшен поставляется с настроеным примером.
- **\[RankSystem] Get Message Count** -- экшен записывает количество сообщений пользователя в аргумент *%messageCount%* по команде **!флуд**. На данный момент записываются сообщения только для вызвашего команду. Для отправки в чат необходимо задать аргумент *%reply%* вида *%userName%* нафлудил *%messageCount%* сообщений. После чего вызвать метод **SendReply**. Экшен поставляется с настроеным примером.
- **\[RankSystem] Get Top Coins** -- экшен формирует топ пользователей по количеству монет по команде **!топ монеты** и отправляет его в чат. Для вывода топа коинов необходимо задать аргумент *%topType%* = *coins*. Для задания количества позиций топа необходимо задать аргумент *%topCount%*. Если *%topCount%* не задан, то будет выведено три позиции в топе. Экшен поставляется с настроеным примером. На данный момент нет верхней планки позицией и нет учёта ограничения количества символов в чатах площадок.
- **\[RankSystem] Get Top Messages** -- экшен формирует топ пользователей по количеству сообщений по команде **!топ флуд** и отправляет его в чат. Для вывода топа сообщений необходимо задать аргумент *%topType%* = *messagecount*. Для задания количества позиций топа необходимо задать аргумент *%topCount%*. Если *%topCount%* не задан, то будет выведено три позиции в топе. Экшен поставляется с настроеным примером. На данный момент нет верхней планки позицией и нет учёта ограничения количества символов в чатах площадок.
- **\[RankSystem] Get Top Whatch Time** -- экшен формирует топ пользователей по времени просмотра по команде **!топ время** и отправляет его в чат. Для вывода топа времени просмотра необходимо задать аргумент *%topType%* = *watchtime*. Для задания количества позиций топа необходимо задать аргумент *%topCount%*. Если *%topCount%* не задан, то будет выведено три позиции в топе. Экшен поставляется с настроеным примером. На данный момент нет верхней планки позицией и нет учёта ограничения количества символов в чатах площадок.
- **\[RankSystem] Get Whatch Time** -- экшен записывает время просмотра стримов пользователем вызвавшим команду **!watchtime** в аргумент *%watchTime%*. На данный момент записывается время только для вызвашего команду. Для отправки в чат необходимо задать аргумент *%reply%* вида *%userName%* смотрит нас *%watchTime%*. После чего вызвать метод **SendReply**. Экшен поставляется с настроеным примером.
- **\[RankSystem] Update Follow Date** -- экшен запоминания даты фоллова (везде) и категории стрима (только twitch). Так же умеет добавлять коины за фоллов.
    - Настройка:
        - Создать отдельный экшен. В триггерах выбрать триггер фоллова с нужной площадки. В сабэкшенах добавить **Core -> Actions -> Run Action ->** *\[RankSystem] Update Follow Date*.
        - Для добавления коинов за фоллов перед Run Action добавить **Core -> Arguments -> Set Argument**. **Variable Name** -> *coinsToAdd*. **Value** -> *количество коинов за фоллов*.
        - Если для твича нужно запоминать категорию стрима, до перед сабэкшеном из предыдущего пункта надо добавить **Twitch -> User -> Get User Info for Target**. В **Source Type** указать *Broadcaster*.
- **\[RankSystem] Update Message Count** -- экшен запоминания количества сообщений. Так же умеет добавлять коины за сообщение.
    - Настройка:
        - Создать отдельный экшен. В триггерах выбрать триггер сообщения с нужной площадки. В сабэкшенах добавить **Core -> Actions -> Run Action** -> *\[RankSystem] Update Message Count*.
        - Для добавления коинов за сообщение перед Run Action добавить **Core -> Arguments -> Set Argument**. **Variable Name** -> *coinsToAdd*. **Value** -> *количество коинов за сообщение*.
- **\[RankSystem] Update Watchtime** -- экшен обновления времени просмотра стримов пользователем. Предназначен для вызова из других экшенов. Так же умеет добавлять коины за время просмотра.
    - Настройка для Twitch:
        -**Platforms -> Twitch -> Settings -> Present Viewers**. Поставить галочки *Enabled* и *Live Update*. Установить ползунок на значение *1 minute*.
        - Создать отдельный экшен. В триггерах выбрать  **General -> Present Viewers**. В сабэкшенах добавить **Core -> Actions -> Run Action** -> *\[RankSystem] Update Watchtime*.
        - В случае если таймер **Present Viewers** был установлен на значение отличное от *1 minute* необходимо задать время таймера в секундах. Перед **Run Action** добавить **Core -> Arguments -> Set Argument**. **Variable Name** -> *timeToAdd*. **Value** -> *время таймера в секундах*.
        - Для добавления коинов за одно срабатываение таймера перед **Run Action** добавить **Core -> Arguments -> Set Argument**. **Variable Name** -> *coinsToAdd*. **Value** -> *количество коинов за одно срабатывание*.
    - Настройка для VkVideoLive неактуальна в связи с обновлением площадки от 18.02.2025.
    - Настройка для Trovo. Нуждается в тестировании, вероятен сценарий ютубуа, описанный в соотетствующем пункте:
        - **Platforms -> Trovo -> Settings -> Present Viewers**. Поставить галочку *Enabled*. Установить ползунок на значение *1 minute*.
        - Создать отдельный экшен. В триггерах выбрать **Trovo -> General -> Present Viewers**. В сабэкшенах добавить **Core -> Actions -> Run Action** -> *\[RankSystem] Update Watchtime*.
        - В случае если таймер **Present Viewers** был установлен на значение отличное от *1 minute* необходимо задать время таймера в секундах. Перед **Run Action** добавить **Core -> Arguments -> Set Argument**. **Variable Name** -> *timeToAdd*. **Value** -> *время таймера в секундах*.
        - Для добавления коинов за одно срабатываение таймера перед **Run Action** добавить **Core -> Arguments -> Set Argument. Variable Name** -> *coinsToAdd*. **Value** -> *количество коинов за одно срабатывание*.
    - Настройка для Youtube. У ютуба нет понятия "сисок зрителей". Есть понятие "список активных чаттеров". Если пользователь был активен за последние n минут -- он есть в списке. Соответственно, пользователю надо писать в чат каждые n минут, чтобы ему корректо засчитывалось время просмотра:
        - **Platforms -> YouTube -> Settings -> Present Viewers**. Поставить галочку *Enabled*. Установить ползунок на значение *10 minute*. Таймер всё равно будет срабатывать раз минуту, но пользователь будет находиться в списке, если он писал в чат за последние 10 минут.
        - Создать отдельный экшен. В триггерах выбрать **YouTube -> General -> Present Viewers**. В сабэкшенах добавить **Core -> Actions -> Run Action** -> *\[RankSystem] Update Watchtime*.
        - Для добавления коинов за минуту просмотра перед **Run Action** добавить **Core -> Arguments -> Set Argument**. **Variable Name** -> *coinsToAdd*. **Value** -> *количество коинов за одно срабатывание*.
    - Для ютуба и трово отсутствует галочка *Live Update*, при этом в документации она для трово присутствует. Подозреваю, что present viewers для трово работает так же, как и для ютуба.

### Экшены группы \[RankSystem][Manage]
- **\[RankSystem] Clear All Users Coins** -- экшен для обнуления коинов у всех пользователей. Использовать с осторожностью!
- **\[RankSystem] DROP DATABASE** -- экшен для ⚠***полного удаления***⚠ всей базы.
- **\[RankSystem] SetBlackList** -- в экшене можно задать чёрный список пользователей, на которых не должна реагировать ранговая система. задаётся в формате userName1;userName2;userName3.
    - чёрный список нуждается в переработке и не рекомендован к использованию в текущем виде.

Остальные экшены будут описаны позже. Следите за обновлениями.

## License
This project is licensed under the [Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License](https://creativecommons.org/licenses/by-nc-sa/4.0/).  
**You are free to:**
- Share — copy and redistribute the code.
- Adapt — modify, transform, and build upon the code.

**Under the following terms:**
- Attribution — You must give appropriate credit.
- NonCommercial — You may not use the material for commercial purposes.
- ShareAlike — If you remix or modify the code, you must distribute your contributions under the same license.

See the [LICENSE](LICENSE) file for the full legal text.